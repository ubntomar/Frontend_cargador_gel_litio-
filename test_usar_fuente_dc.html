<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîå Test Espec√≠fico: Usar Fuente DC</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .success { 
            background: #f0f9ff; 
            border-color: #0ea5e9;
        }
        .error { 
            background: #fef2f2; 
            border-color: #ef4444;
        }
        .warning { 
            background: #fffbeb; 
            border-color: #f59e0b;
        }
        .info {
            background: #f8fafc;
            border-color: #64748b;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #2563eb; }
        button:disabled { 
            background: #9ca3af; 
            cursor: not-allowed; 
        }
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .log {
            max-height: 300px;
            overflow-y: auto;
            background: #1f2937;
            color: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-online {
            background: #dcfce7;
            color: #166534;
        }
        .status-offline {
            background: #fecaca;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå Test Espec√≠fico: "Usar Fuente DC"</h1>
        <p>Diagn√≥stico espec√≠fico para el error DOMException al cambiar el par√°metro "Usar Fuente DC"</p>
        
        <div class="test-section info">
            <h3>üìä Estado del Sistema</h3>
            <p><strong>API:</strong> <span id="api-status" class="status status-offline">Verificando...</span></p>
            <p><strong>ESP32:</strong> <span id="esp32-status" class="status status-offline">Verificando...</span></p>
            <p><strong>√öltimo error:</strong> <span id="last-error">Ninguno</span></p>
            <button onclick="checkSystemStatus()">üîÑ Verificar Estado</button>
        </div>

        <div class="test-section">
            <h3>üì° Test 1: Datos Actuales del ESP32</h3>
            <p>Obtener estado actual del par√°metro useFuenteDC:</p>
            <button onclick="getCurrentData()">üìä Obtener Datos</button>
            <div id="current-data"></div>
        </div>

        <div class="test-section">
            <h3>‚ö° Test 2: Cambio Controlado de useFuenteDC</h3>
            <p>Cambiar el valor del par√°metro con manejo de errores:</p>
            <button onclick="testUseFuenteDC(true)">‚úÖ Activar Fuente DC</button>
            <button onclick="testUseFuenteDC(false)">‚ùå Desactivar Fuente DC</button>
            <div id="parameter-test-results"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Test 3: Simulaci√≥n de Notificaci√≥n</h3>
            <p>Probar el sistema de notificaciones con el texto problem√°tico:</p>
            <button onclick="testNotificationSystem()">üîî Probar Notificaciones</button>
            <div id="notification-test-results"></div>
        </div>

        <div class="test-section">
            <h3>üîç Test 4: An√°lisis de Caracteres</h3>
            <p>Analizar el string "Usar Fuente DC" en detalle:</p>
            <button onclick="analyzeCharacters()">üî¨ Analizar</button>
            <div id="character-analysis"></div>
        </div>

        <div class="test-section">
            <h3>üìù Log de Eventos</h3>
            <button onclick="clearLog()">üßπ Limpiar Log</button>
            <button onclick="enableErrorCapture()">üéØ Capturar Errores</button>
            <div id="event-log" class="log"></div>
        </div>
    </div>

    <script>
        let errorCaptureEnabled = false;
        let logContainer = null;

        // Funci√≥n de logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(`[${type.toUpperCase()}] ${logEntry}`);
            
            if (logContainer) {
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = logEntry;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', () => {
            logContainer = document.getElementById('event-log');
            enableErrorCapture();
            checkSystemStatus();
            log('Test espec√≠fico iniciado', 'info');
        });

        // Captura de errores globales
        function enableErrorCapture() {
            if (errorCaptureEnabled) return;
            
            errorCaptureEnabled = true;
            
            window.addEventListener('error', (event) => {
                log(`ERROR: ${event.message} en ${event.filename}:${event.lineno}`, 'error');
                document.getElementById('last-error').textContent = event.message;
            });

            window.addEventListener('unhandledrejection', (event) => {
                log(`PROMISE REJECTION: ${event.reason}`, 'error');
                document.getElementById('last-error').textContent = event.reason;
            });

            log('Captura de errores activada', 'success');
        }

        function clearLog() {
            if (logContainer) {
                logContainer.innerHTML = '';
            }
        }

        // Verificar estado del sistema
        async function checkSystemStatus() {
            log('Verificando estado del sistema...', 'info');
            
            // Verificar API
            try {
                const response = await fetch('http://localhost:8000/health', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    document.getElementById('api-status').textContent = 'Online';
                    document.getElementById('api-status').className = 'status status-online';
                    log('API disponible', 'success');
                    
                    const health = await response.json();
                    if (health.esp32_connected) {
                        document.getElementById('esp32-status').textContent = 'Conectado';
                        document.getElementById('esp32-status').className = 'status status-online';
                        log('ESP32 conectado', 'success');
                    } else {
                        document.getElementById('esp32-status').textContent = 'Desconectado';
                        document.getElementById('esp32-status').className = 'status status-offline';
                        log('ESP32 desconectado', 'warning');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('api-status').textContent = 'Offline';
                document.getElementById('api-status').className = 'status status-offline';
                log(`Error conectando a API: ${error.message}`, 'error');
            }
        }

        // Obtener datos actuales
        async function getCurrentData() {
            log('Obteniendo datos actuales...', 'info');
            const container = document.getElementById('current-data');
            container.innerHTML = '<div>üîÑ Cargando...</div>';
            
            try {
                const response = await fetch('http://localhost:8000/data/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log('Datos obtenidos exitosamente', 'success');
                
                const html = `
                    <div class="success">
                        <h4>‚úÖ Datos Actuales</h4>
                        <p><strong>useFuenteDC:</strong> ${data.useFuenteDC}</p>
                        <p><strong>fuenteDC_Amps:</strong> ${data.fuenteDC_Amps}</p>
                        <p><strong>Conexi√≥n ESP32:</strong> ${data.esp32_connection?.status || 'unknown'}</p>
                        <pre>${JSON.stringify({ 
                            useFuenteDC: data.useFuenteDC, 
                            fuenteDC_Amps: data.fuenteDC_Amps 
                        }, null, 2)}</pre>
                    </div>
                `;
                container.innerHTML = html;
                
            } catch (error) {
                log(`Error obteniendo datos: ${error.message}`, 'error');
                container.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Test espec√≠fico para useFuenteDC
        async function testUseFuenteDC(value) {
            log(`Probando cambio de useFuenteDC a ${value}...`, 'info');
            const container = document.getElementById('parameter-test-results');
            container.innerHTML = '<div>üîÑ Procesando...</div>';
            
            try {
                // Preparar datos de la petici√≥n
                const requestData = {
                    parameter: 'useFuenteDC',
                    value: value
                };
                
                log(`Datos de petici√≥n: ${JSON.stringify(requestData)}`, 'info');
                
                // An√°lisis del string antes de enviar
                const paramString = 'useFuenteDC';
                log(`Analizando par√°metro: "${paramString}"`, 'info');
                log(`Length: ${paramString.length}, Chars: ${Array.from(paramString).map(c => c.charCodeAt(0)).join(', ')}`, 'info');
                
                // Realizar petici√≥n
                const response = await fetch('http://localhost:8000/config/parameter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                log(`Response status: ${response.status}`, 'info');
                
                const result = await response.json();
                log(`Response data: ${JSON.stringify(result)}`, 'info');
                
                if (response.ok && result.success) {
                    container.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Cambio Exitoso</h4>
                            <p><strong>Par√°metro:</strong> ${result.parameter}</p>
                            <p><strong>Nuevo valor:</strong> ${result.value}</p>
                            <p><strong>Respuesta ESP32:</strong> ${result.esp32_response}</p>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                    log('Par√°metro cambiado exitosamente', 'success');
                } else {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }
                
            } catch (error) {
                log(`Error cambiando par√°metro: ${error.message}`, 'error');
                container.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p><strong>Mensaje:</strong> ${error.message}</p>
                        <p><strong>Tipo:</strong> ${error.constructor.name}</p>
                        <pre>${error.stack || 'No stack trace'}</pre>
                    </div>
                `;
                
                // Registro detallado del error
                if (error instanceof DOMException) {
                    log(`DOMException detectada: ${error.name} - ${error.message}`, 'error');
                    log(`Code: ${error.code}`, 'error');
                }
            }
        }

        // Test del sistema de notificaciones
        function testNotificationSystem() {
            log('Probando sistema de notificaciones...', 'info');
            const container = document.getElementById('notification-test-results');
            
            const problematicStrings = [
                'Usar Fuente DC',
                'Configurando Usar Fuente DC',
                'Usar Fuente DC configurado',
                'Error configurando Usar Fuente DC'
            ];
            
            let results = '<h4>üîî Pruebas de Notificaci√≥n:</h4>';
            
            problematicStrings.forEach((str, index) => {
                try {
                    // Simular generaci√≥n de ID
                    const id = Date.now().toString() + Math.random().toString(36).substring(2, 11);
                    
                    // Simular sanitizaci√≥n
                    const sanitized = str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    
                    // Simular template strings
                    const template1 = `Configurando ${str}`;
                    const template2 = `${str} aplicado exitosamente`;
                    
                    results += `
                        <div style="margin: 10px 0; padding: 8px; background: #f0f9ff; border-radius: 4px;">
                            <strong>Test ${index + 1}:</strong> "${str}"<br>
                            ‚úÖ ID: ${id}<br>
                            ‚úÖ Sanitized: "${sanitized}"<br>
                            ‚úÖ Template 1: "${template1}"<br>
                            ‚úÖ Template 2: "${template2}"
                        </div>
                    `;
                    
                    log(`Notification test ${index + 1} passed: "${str}"`, 'success');
                } catch (error) {
                    results += `
                        <div style="margin: 10px 0; padding: 8px; background: #fef2f2; border-radius: 4px;">
                            <strong>Test ${index + 1}:</strong> "${str}"<br>
                            ‚ùå Error: ${error.message}
                        </div>
                    `;
                    log(`Notification test ${index + 1} failed: ${error.message}`, 'error');
                }
            });
            
            container.innerHTML = results;
        }

        // An√°lisis detallado de caracteres
        function analyzeCharacters() {
            log('Analizando caracteres de "Usar Fuente DC"...', 'info');
            const container = document.getElementById('character-analysis');
            
            const testString = 'Usar Fuente DC';
            
            let analysis = `<h4>üî¨ An√°lisis de "${testString}":</h4>`;
            
            // Informaci√≥n b√°sica
            analysis += `<p><strong>Length:</strong> ${testString.length}</p>`;
            analysis += `<p><strong>Bytes (UTF-8):</strong> ${new TextEncoder().encode(testString).length}</p>`;
            
            // An√°lisis char por char
            analysis += `<h5>Caracteres individuales:</h5>`;
            analysis += `<table style="border-collapse: collapse; width: 100%;">`;
            analysis += `<tr style="background: #f3f4f6;"><th style="border: 1px solid #ddd; padding: 5px;">Char</th><th style="border: 1px solid #ddd; padding: 5px;">Code</th><th style="border: 1px solid #ddd; padding: 5px;">UTF-8</th><th style="border: 1px solid #ddd; padding: 5px;">Type</th></tr>`;
            
            for (let i = 0; i < testString.length; i++) {
                const char = testString[i];
                const code = char.charCodeAt(0);
                const utf8 = new TextEncoder().encode(char);
                const type = code > 127 ? 'Non-ASCII' : 'ASCII';
                
                analysis += `<tr>`;
                analysis += `<td style="border: 1px solid #ddd; padding: 5px;">'${char}'</td>`;
                analysis += `<td style="border: 1px solid #ddd; padding: 5px;">${code}</td>`;
                analysis += `<td style="border: 1px solid #ddd; padding: 5px;">[${Array.from(utf8).join(', ')}]</td>`;
                analysis += `<td style="border: 1px solid #ddd; padding: 5px;">${type}</td>`;
                analysis += `</tr>`;
            }
            analysis += `</table>`;
            
            // Pruebas de codificaci√≥n
            analysis += `<h5>Pruebas de codificaci√≥n:</h5>`;
            
            try {
                const encoded = encodeURIComponent(testString);
                analysis += `‚úÖ encodeURIComponent: "${encoded}"<br>`;
            } catch (e) {
                analysis += `‚ùå encodeURIComponent: ${e.message}<br>`;
            }
            
            try {
                const normalized = testString.normalize('NFD');
                analysis += `‚úÖ normalize('NFD'): "${normalized}"<br>`;
            } catch (e) {
                analysis += `‚ùå normalize('NFD'): ${e.message}<br>`;
            }
            
            try {
                const sanitized = testString.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                analysis += `‚úÖ sanitized: "${sanitized}"<br>`;
            } catch (e) {
                analysis += `‚ùå sanitized: ${e.message}<br>`;
            }
            
            try {
                const json = JSON.stringify({title: testString});
                analysis += `‚úÖ JSON.stringify: ${json}<br>`;
            } catch (e) {
                analysis += `‚ùå JSON.stringify: ${e.message}<br>`;
            }
            
            container.innerHTML = analysis;
            log('An√°lisis de caracteres completado', 'success');
        }
    </script>
</body>
</html>
