<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Configuraci√≥n Individual - Spinner & Timeouts</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f0f8ff; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .test-group { 
            margin: 20px 0; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            border-left: 4px solid #007bff; 
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        .loading { border-left-color: #6f42c1; background: #e2d9f3; }
        
        .parameter-test {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 3px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #000; }
        button.danger { background: #dc3545; }
        
        .spinner {
            display: inline-block;
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-bar {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100px;
            margin-right: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .log-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .notification-mock {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 350px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .notification-mock.show {
            transform: translateX(0);
        }
        .notification-mock.success { border-left-color: #28a745; }
        .notification-mock.error { border-left-color: #dc3545; }
        .notification-mock.warning { border-left-color: #ffc107; }
        .notification-mock.loading { border-left-color: #6f42c1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Configuraci√≥n Individual - Spinner & Timeouts</h1>
        <p>Esta p√°gina prueba espec√≠ficamente las mejoras para configuraci√≥n de par√°metros individuales con spinner y mejor manejo de timeouts.</p>
        
        <!-- Status del Sistema -->
        <div class="test-group info">
            <h3>üìä Estado del Sistema</h3>
            <div id="system-status">Verificando...</div>
            <div id="current-parameters" class="mt-3">
                <h4>Par√°metros Actuales:</h4>
                <div id="parameters-list">Cargando...</div>
            </div>
        </div>
        
        <!-- Test de Par√°metros Individuales -->
        <div class="test-group">
            <h3>‚öôÔ∏è Test de Configuraci√≥n Individual</h3>
            <p><strong>Nuevo comportamiento:</strong></p>
            <ul>
                <li>‚úÖ Spinner animado durante configuraci√≥n (hasta 15s)</li>
                <li>‚úÖ Notificaciones informativas</li>
                <li>‚úÖ Manejo espec√≠fico de errores de lock/timeout</li>
                <li>‚úÖ Feedback visual mejorado</li>
            </ul>
            
            <!-- Test useFuenteDC -->
            <div class="parameter-test">
                <h4>üîå useFuenteDC (Par√°metro que caus√≥ el error)</h4>
                <div>
                    <button id="toggle-fuente-btn" onclick="testUseFuenteDC()">
                        <span id="fuente-spinner" class="spinner" style="display: none;">‚è≥</span>
                        <span id="fuente-text">Alternar useFuenteDC</span>
                    </button>
                    <span id="fuente-status">Estado: Cargando...</span>
                </div>
                <div id="fuente-result" class="status-bar" style="display: none;"></div>
            </div>
            
            <!-- Test batteryCapacity -->
            <div class="parameter-test">
                <h4>üîã batteryCapacity</h4>
                <div>
                    <input type="number" id="battery-input" value="100" min="50" max="500" step="1">
                    <button onclick="testBatteryCapacity()">
                        <span id="battery-spinner" class="spinner" style="display: none;">‚è≥</span>
                        <span id="battery-text">Configurar Capacidad</span>
                    </button>
                    <span id="battery-status">Valor actual: Cargando...</span>
                </div>
                <div id="battery-result" class="status-bar" style="display: none;"></div>
            </div>
            
            <!-- Test bulkVoltage -->
            <div class="parameter-test">
                <h4>‚ö° bulkVoltage</h4>
                <div>
                    <input type="number" id="bulk-input" value="14.4" min="13.8" max="15.0" step="0.1">
                    <button onclick="testBulkVoltage()">
                        <span id="bulk-spinner" class="spinner" style="display: none;">‚è≥</span>
                        <span id="bulk-text">Configurar Voltaje BULK</span>
                    </button>
                    <span id="bulk-status">Valor actual: Cargando...</span>
                </div>
                <div id="bulk-result" class="status-bar" style="display: none;"></div>
            </div>
            
            <!-- Test Simult√°neo (para generar lock) -->
            <div class="parameter-test">
                <h4>üîÑ Test Simult√°neo (Generar Lock)</h4>
                <div>
                    <button onclick="testSimultaneous()">
                        <span id="simultaneous-spinner" class="spinner" style="display: none;">‚è≥</span>
                        <span id="simultaneous-text">Configurar 3 par√°metros simult√°neamente</span>
                    </button>
                    <p class="text-sm text-gray-600 mt-2">
                        Este test intenta configurar m√∫ltiples par√°metros al mismo tiempo para simular el error de lock.
                    </p>
                </div>
                <div id="simultaneous-result" class="status-bar" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Log de Eventos -->
        <div class="test-group">
            <h3>üìù Log de Eventos</h3>
            <button onclick="clearLog()">Limpiar Log</button>
            <div id="event-log" class="log-area"></div>
        </div>
        
        <!-- Estad√≠sticas -->
        <div class="test-group">
            <h3>üìä Estad√≠sticas de Pruebas</h3>
            <div id="test-stats">
                <div>Requests exitosos: <span id="success-count">0</span></div>
                <div>Timeouts: <span id="timeout-count">0</span></div>
                <div>Errores de lock: <span id="lock-count">0</span></div>
                <div>Otros errores: <span id="error-count">0</span></div>
            </div>
        </div>
    </div>
    
    <!-- Notificaci√≥n Mock -->
    <div id="notification-mock" class="notification-mock">
        <div class="flex items-start">
            <div id="notification-icon">‚ÑπÔ∏è</div>
            <div class="ml-3">
                <div id="notification-title" class="font-medium"></div>
                <div id="notification-message" class="text-sm mt-1"></div>
                <div id="notification-progress" class="progress-bar" style="display: none;">
                    <div id="notification-progress-fill" class="progress-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let stats = {
            success: 0,
            timeout: 0,
            lock: 0,
            error: 0
        };
        
        let currentParameters = {};
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('event-log');
            const logClass = type === 'error' ? 'color: red;' : 
                           type === 'success' ? 'color: green;' : 
                           type === 'warning' ? 'color: orange;' : '';
            
            logArea.innerHTML += `<div style="${logClass}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('event-log').innerHTML = '';
        }
        
        function updateStats() {
            document.getElementById('success-count').textContent = stats.success;
            document.getElementById('timeout-count').textContent = stats.timeout;
            document.getElementById('lock-count').textContent = stats.lock;
            document.getElementById('error-count').textContent = stats.error;
        }
        
        function showNotification(title, message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification-mock');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');
            const iconEl = document.getElementById('notification-icon');
            
            // Configurar contenido
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Configurar icono y estilo
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                loading: '‚è≥',
                info: '‚ÑπÔ∏è'
            };
            iconEl.textContent = icons[type] || icons.info;
            
            // Aplicar clase de estilo
            notification.className = `notification-mock ${type} show`;
            
            // Auto-ocultar
            if (type !== 'loading' && duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }
            
            return notification;
        }
        
        function hideNotification() {
            const notification = document.getElementById('notification-mock');
            notification.classList.remove('show');
        }
        
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                document.getElementById('system-status').innerHTML = `
                    <div class="success">‚úÖ Backend disponible</div>
                    <div>Timeout configurado: 30s (mejorado desde 10s)</div>
                `;
                
                // Cargar par√°metros actuales
                await loadCurrentParameters();
                
            } catch (error) {
                document.getElementById('system-status').innerHTML = `
                    <div class="error">‚ùå Backend no disponible: ${error.message}</div>
                `;
            }
        }
        
        async function loadCurrentParameters() {
            try {
                const response = await fetch(`${API_BASE}/data/`);
                const data = await response.json();
                
                currentParameters = {
                    useFuenteDC: data.useFuenteDC,
                    batteryCapacity: data.batteryCapacity,
                    bulkVoltage: data.bulkVoltage
                };
                
                document.getElementById('parameters-list').innerHTML = `
                    <div>useFuenteDC: <strong>${data.useFuenteDC ? 'S√≠' : 'No'}</strong></div>
                    <div>batteryCapacity: <strong>${data.batteryCapacity} Ah</strong></div>
                    <div>bulkVoltage: <strong>${data.bulkVoltage} V</strong></div>
                `;
                
                // Actualizar status individuales
                document.getElementById('fuente-status').textContent = 
                    `Estado: ${data.useFuenteDC ? 'Activado' : 'Desactivado'}`;
                document.getElementById('battery-status').textContent = 
                    `Valor actual: ${data.batteryCapacity} Ah`;
                document.getElementById('bulk-status').textContent = 
                    `Valor actual: ${data.bulkVoltage} V`;
                    
            } catch (error) {
                log('Error cargando par√°metros actuales: ' + error.message, 'error');
            }
        }
        
        async function testParameter(parameterName, value, buttonId, spinnerId, textId, resultId, statusId) {
            const button = document.getElementById(buttonId);
            const spinner = document.getElementById(spinnerId);
            const text = document.getElementById(textId);
            const result = document.getElementById(resultId);
            const status = document.getElementById(statusId);
            
            // UI Loading state
            button.disabled = true;
            spinner.style.display = 'inline-block';
            text.textContent = `Configurando... (hasta 15s)`;
            result.style.display = 'none';
            
            // Mostrar notificaci√≥n de loading
            showNotification(
                `Configurando ${parameterName}`,
                'Enviando al ESP32... (hasta 15s)',
                'loading'
            );
            
            const startTime = Date.now();
            
            try {
                log(`Configurando ${parameterName} = ${value}...`);
                
                const response = await fetch(`${API_BASE}/config/parameter`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parameter: parameterName,
                        value: value
                    })
                });
                
                const responseTime = ((Date.now() - startTime) / 1000).toFixed(2);
                const data = await response.json();
                
                hideNotification();
                
                if (response.ok && data.success) {
                    stats.success++;
                    result.className = 'status-bar success';
                    result.innerHTML = `‚úÖ Configurado exitosamente en ${responseTime}s`;
                    
                    showNotification(
                        `${parameterName} configurado`,
                        `Par√°metro aplicado exitosamente en ${responseTime}s`,
                        'success'
                    );
                    
                    log(`‚úÖ ${parameterName} configurado exitosamente (${responseTime}s)`, 'success');
                    
                    // Actualizar par√°metros
                    await loadCurrentParameters();
                    
                } else {
                    stats.error++;
                    result.className = 'status-bar error';
                    result.innerHTML = `‚ùå Error: ${data.detail || data.message || 'Error desconocido'}`;
                    
                    showNotification(
                        `Error configurando ${parameterName}`,
                        data.detail || data.message || 'Error desconocido',
                        'error'
                    );
                    
                    log(`‚ùå Error configurando ${parameterName}: ${data.detail || data.message}`, 'error');
                }
                
            } catch (error) {
                const responseTime = ((Date.now() - startTime) / 1000).toFixed(2);
                hideNotification();
                
                if (error.message.includes('timeout')) {
                    stats.timeout++;
                    result.className = 'status-bar warning';
                    result.innerHTML = `‚è∞ Timeout despu√©s de ${responseTime}s - ESP32 puede estar ocupado`;
                    
                    showNotification(
                        `Timeout configurando ${parameterName}`,
                        'El ESP32 puede estar ocupado. Intenta nuevamente en unos segundos.',
                        'warning',
                        8000
                    );
                    
                    log(`‚è∞ Timeout configurando ${parameterName} (${responseTime}s)`, 'warning');
                    
                } else if (error.message.includes('lock')) {
                    stats.lock++;
                    result.className = 'status-bar warning';
                    result.innerHTML = `üîí ESP32 ocupado - Otro par√°metro se est√° configurando`;
                    
                    showNotification(
                        'ESP32 ocupado',
                        `No se pudo configurar ${parameterName}. Otro par√°metro se est√° configurando.`,
                        'warning',
                        6000
                    );
                    
                    log(`üîí Lock error configurando ${parameterName}`, 'warning');
                    
                } else {
                    stats.error++;
                    result.className = 'status-bar error';
                    result.innerHTML = `‚ùå Error: ${error.message}`;
                    
                    showNotification(
                        `Error configurando ${parameterName}`,
                        error.message,
                        'error'
                    );
                    
                    log(`‚ùå Error configurando ${parameterName}: ${error.message}`, 'error');
                }
            } finally {
                // Restaurar UI
                button.disabled = false;
                spinner.style.display = 'none';
                text.textContent = text.textContent.replace('Configurando... (hasta 15s)', text.getAttribute('data-original') || 'Configurar');
                result.style.display = 'block';
                
                updateStats();
            }
        }
        
        // Test functions espec√≠ficas
        async function testUseFuenteDC() {
            const currentValue = currentParameters.useFuenteDC || false;
            const newValue = !currentValue;
            
            document.getElementById('fuente-text').setAttribute('data-original', 'Alternar useFuenteDC');
            
            await testParameter(
                'useFuenteDC', 
                newValue, 
                'toggle-fuente-btn', 
                'fuente-spinner', 
                'fuente-text', 
                'fuente-result',
                'fuente-status'
            );
        }
        
        async function testBatteryCapacity() {
            const value = parseFloat(document.getElementById('battery-input').value);
            
            document.getElementById('battery-text').setAttribute('data-original', 'Configurar Capacidad');
            
            await testParameter(
                'batteryCapacity', 
                value, 
                'battery-spinner', 
                'battery-spinner', 
                'battery-text', 
                'battery-result',
                'battery-status'
            );
        }
        
        async function testBulkVoltage() {
            const value = parseFloat(document.getElementById('bulk-input').value);
            
            document.getElementById('bulk-text').setAttribute('data-original', 'Configurar Voltaje BULK');
            
            await testParameter(
                'bulkVoltage', 
                value, 
                'bulk-spinner', 
                'bulk-spinner', 
                'bulk-text', 
                'bulk-result',
                'bulk-status'
            );
        }
        
        async function testSimultaneous() {
            const button = document.getElementById('simultaneous-text');
            const spinner = document.getElementById('simultaneous-spinner');
            const result = document.getElementById('simultaneous-result');
            
            button.textContent = 'Configurando 3 par√°metros...';
            spinner.style.display = 'inline-block';
            result.style.display = 'none';
            
            showNotification(
                'Test simult√°neo',
                'Configurando m√∫ltiples par√°metros para simular lock...',
                'loading'
            );
            
            log('Iniciando test simult√°neo para simular lock...', 'info');
            
            try {
                // Lanzar 3 requests simult√°neos
                const promises = [
                    testParameter('batteryCapacity', 150, 'dummy', 'dummy', 'dummy', 'dummy', 'dummy'),
                    testParameter('bulkVoltage', 14.2, 'dummy', 'dummy', 'dummy', 'dummy', 'dummy'),
                    testParameter('useFuenteDC', true, 'dummy', 'dummy', 'dummy', 'dummy', 'dummy')
                ];
                
                await Promise.allSettled(promises);
                
                hideNotification();
                showNotification(
                    'Test simult√°neo completado',
                    'Revisa el log para ver los resultados',
                    'info'
                );
                
                result.className = 'status-bar info';
                result.innerHTML = '‚úÖ Test completado - Revisa el log para ver los resultados';
                
            } catch (error) {
                hideNotification();
                showNotification(
                    'Error en test simult√°neo',
                    error.message,
                    'error'
                );
                
                result.className = 'status-bar error';
                result.innerHTML = `‚ùå Error en test: ${error.message}`;
            } finally {
                button.textContent = 'Configurar 3 par√°metros simult√°neamente';
                spinner.style.display = 'none';
                result.style.display = 'block';
            }
        }
        
        // Inicializar
        window.addEventListener('load', () => {
            checkSystemStatus();
            updateStats();
            log('P√°gina de test cargada - Timeout configurado a 30s', 'info');
        });
    </script>
</body>
</html>
